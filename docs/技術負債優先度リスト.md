# Bibli 技術負債優先度リスト

実装状況を確認したうえで、影響度と修正コストを基準に優先度を付けています。

## 優先度定義

- `P0`: 直ちに対応すべき（情報漏えい・重大障害リスク）
- `P1`: 早期対応すべき（機能拡張や保守性に重大な悪影響）
- `P2`: 中期で対応（品質改善・運用コスト削減）
- `P3`: 余力で対応（整理・最適化）

## P0（最優先）

| ID | 課題 | 根拠 | 影響 | 対応案 |
|---|---|---|---|---|
| P0-1 | Firebaseサービスアカウント秘密鍵がリポジトリ内に存在 | `firebase.json` に `private_key` が含まれる | 鍵漏えいによる不正アクセス・乗っ取り | 即時ローテーション、履歴から除去、秘密情報はSecret Manager/環境変数に移行 |

## P1（高優先）

| ID | 課題 | 根拠 | 影響 | 対応案 |
|---|---|---|---|---|
| P1-1 | 認証方式が混在し境界が曖昧 | Firebase認証 + `/api/login` JWT が並立、バックエンドでFirebaseトークン検証未導入 | なりすまし・権限制御の不整合 | 認証方式を一本化（推奨: Firebase ID Token検証）、認可ミドルウェア導入 |
| P1-2 | APIベースURLがフロントで直書き | 多数の画面で `http://localhost:5000` 直書き | 本番/検証環境切替ミス、修正コスト増加 | `apiBase.js` に統一し、全 fetch を `apiUrl()` 経由に置換 |
| P1-3 | DB接続設定がコード固定 | `backend/app.py` で `mysql+pymysql://root:root@localhost/bibli_db` 直書き | 環境差分に弱く、機密情報管理も不適切 | `DATABASE_URL` を必須化し、`config.py`/`.env` に集約 |
| P1-4 | バックエンド単一ファイル肥大化 | `backend/app.py` 約 3000 行 | 変更衝突・レビュー困難・障害調査の遅延 | Blueprint分割（auth/products/forum/payments等）、service/repository分離 |
| P1-5 | テスト不足 | `backend/tests/test_health.py` のみ | 仕様変更時の回帰検知不可 | API主要系の統合テスト追加（認証・出品・購入・通知・掲示板） |

## P2（中優先）

| ID | 課題 | 根拠 | 影響 | 対応案 |
|---|---|---|---|---|
| P2-1 | フォローAPIが重複 | `/api/forum/follow*` と `/api/follow*` が同等機能 | 仕様分岐・保守重複 | 片方へ集約し、互換期間後に廃止 |
| P2-2 | エラーハンドリング方針の不統一 | 一部APIで例外時でも `200` 返却あり | 監視検知漏れ、フロント分岐複雑化 | HTTPステータス規約を統一（4xx/5xxを正しく返却） |
| P2-3 | JWT秘密鍵が起動ごとに変化 | `SECRET_KEY = secrets.token_hex(32)` | 再起動で既存トークン無効化 | 固定Secretを環境変数管理 |
| P2-4 | マイグレーション運用なし | `db.create_all()` 依存 | 本番スキーマ変更時に事故リスク | Alembic/Flask-Migrate導入 |

## P3（低優先）

| ID | 課題 | 根拠 | 影響 | 対応案 |
|---|---|---|---|---|
| P3-1 | 旧資産ファイルの残存 | `frontend/src/css/js/*` など未使用JSが混在 | 誤参照リスク、可読性低下 | 使用有無を棚卸しして削除/隔離 |
| P3-2 | 一部文面・データが固定値 | `DUMMY_NEWS_POSTS` 固定、情報ページ日付固定 | 運用更新漏れ | CMS化またはDB管理へ移行 |
| P3-3 | ドキュメントと実装の乖離 | `COMPONENT_CONVERSION_SUMMARY.md` が現状と不一致 | 新規参加者の誤解 | 現行構成に合わせて更新 |

## 実行順（推奨）

1. `P0-1` 秘密鍵対応（漏えい対策を最優先）
2. `P1-1` 認証基盤の統一
3. `P1-2` API呼び出しのURL統一
4. `P1-3` DB設定の環境変数化
5. `P1-4` バックエンド分割
6. `P1-5` テスト整備
7. `P2` 以降の整理（重複API、ステータス統一、マイグレーション）
